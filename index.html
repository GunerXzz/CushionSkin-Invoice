<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Maker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Khmer-friendly font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Battambang", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* A4 in PX (stable for Safari/html2canvas) */
    :root{
      --a4w: 794px;
      --a4h: 1123px;
      --pad: 56px;
    }

    .paper {
      width: var(--a4w);
      min-height: var(--a4h);
      background: #fff;
      padding: var(--pad);
      position: relative;
      transform: none !important;
    }

    /* Mobile preview scaling only */
    @media (max-width: 900px) {
      .paper.interactive {
        transform-origin: top left;
        transform: scale(0.50) !important;
        margin-bottom: -520px;
      }
      .previewWrap {
        height: 560px;
        overflow: hidden;
        border-radius: 16px;
      }
    }

    /* Make logo rendering more stable on iOS */
    #logoView {
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
  </style>
</head>

<body class="bg-rose-50">

  <!-- LOGIN -->
  <div id="login" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-rose-50">
    <div class="w-full max-w-sm rounded-2xl bg-white shadow-xl border border-rose-100 p-7 text-center">
      <div class="mx-auto mb-3 h-10 w-10 rounded-xl bg-rose-100 flex items-center justify-center text-rose-600 font-bold">
        CS
      </div>
      <h1 class="text-2xl font-bold text-slate-800">Invoice Maker</h1>
      <p class="mt-1 text-sm text-slate-500">Enter PIN to continue</p>

      <input id="pin" type="password" placeholder="PIN"
        class="mt-5 w-full rounded-xl border-2 border-rose-100 px-4 py-3 text-center text-xl outline-none focus:border-rose-400" />

      <button onclick="checkLogin()"
        class="mt-4 w-full rounded-xl bg-rose-600 py-3 font-bold text-white shadow hover:bg-rose-700">
        Login
      </button>

      <p id="pinErr" class="mt-3 text-sm text-red-500 hidden">Wrong PIN</p>
      <p class="mt-4 text-xs text-slate-400">Note: PIN is not secure if this is public</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden min-h-screen flex flex-col lg:flex-row">

    <!-- LEFT PANEL -->
    <aside class="w-full lg:w-[380px] bg-white border-r border-rose-100 p-6 overflow-y-auto">
      <div class="mb-6">
        <h2 class="text-lg font-bold text-slate-800">Settings</h2>
        <p class="text-xs text-slate-500">Clean modern invoice theme</p>
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase">Shop</h3>

        <label class="block">
          <span class="text-sm text-slate-600">Logo</span>
          <input id="logoInput" type="file" accept="image/*"
            class="mt-2 block w-full text-sm text-rose-600
            file:mr-4 file:rounded-full file:border-0 file:bg-rose-50 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-rose-700 hover:file:bg-rose-100" />
          <p class="mt-1 text-xs text-slate-400">We auto-fix logo for export (removes scratch/moire).</p>
        </label>

        <input id="shopName" value="Cushion Skin" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Shop name" />

        <input id="shopContact" value="Tel: 012 345 678 | Phnom Penh" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Contact line" />
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase">Customer</h3>

        <input id="customer" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Customer name (e.g. Mony 012345678)" />

        <input id="invDate" type="date" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400" />

        <input id="invNo" value="INV-001" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Invoice number" />
      </div>

      <div class="rounded-2xl border border-rose-100 bg-rose-50 p-4 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase mb-3">Items</h3>

        <input id="itemDesc"
          class="w-full rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400 mb-2"
          placeholder="Description" />

        <div class="grid grid-cols-2 gap-2">
          <input id="itemQty" type="number" inputmode="decimal"
            class="rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400"
            placeholder="Qty" />

          <input id="itemPrice" type="number" inputmode="decimal"
            class="rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400"
            placeholder="Price ($)" />
        </div>

        <button onclick="addItem()"
          class="mt-3 w-full rounded-xl bg-rose-600 py-2.5 font-bold text-white shadow hover:bg-rose-700">
          + Add item
        </button>
      </div>

      <div class="mb-6">
        <h3 class="text-xs font-bold tracking-wider text-slate-500 uppercase mb-2">Current items</h3>
        <div id="itemsList" class="space-y-2">
          <p class="text-sm text-slate-400 italic">No items yet.</p>
        </div>
      </div>

      <button onclick="downloadImage()"
        class="w-full rounded-2xl bg-slate-900 py-3 font-bold text-white shadow hover:bg-slate-950">
        Download Image
      </button>
      <p class="mt-2 text-center text-xs text-slate-400">By Sok Chanmony</p>
    </aside>

    <!-- RIGHT PREVIEW -->
    <main class="flex-1 p-4 lg:p-10 bg-rose-100/60 overflow-y-auto">
      <div class="previewWrap mx-auto max-w-fit shadow-2xl rounded-2xl overflow-hidden bg-white">
        <div id="invoice" class="paper interactive">

          <!-- Top bar -->
          <div class="absolute left-0 top-0 h-2 w-full bg-rose-600"></div>

          <!-- Header -->
          <div class="mt-4 flex items-start justify-between gap-8">
            <div class="min-w-0">
              <div class="flex items-center gap-4">
                <!-- Clean logo block (fixed height, no weird scaling) -->
                <div class="h-14 w-40 rounded-xl border border-rose-100 bg-rose-50 overflow-hidden flex items-center justify-center">
                  <img id="logoView" class="max-h-14 max-w-40 object-contain hidden" alt="Logo" />
                  <span id="logoFallback" class="text-xs text-slate-400">LOGO</span>
                </div>

                <div class="min-w-0">
                  <div id="vShopName" class="text-3xl font-extrabold tracking-tight text-slate-900 leading-none truncate">
                    Cushion Skin
                  </div>
                  <div id="vShopContact" class="mt-2 text-sm text-slate-500">
                    Tel: 012 345 678 | Phnom Penh
                  </div>
                </div>
              </div>
            </div>

            <div class="text-right flex flex-col items-end gap-2">
              <!-- FIXED HEIGHT badge = always centered -->
              <div class="h-12 px-8 rounded-full bg-rose-600 text-white inline-flex items-center justify-center shadow">
                <span class="text-2xl font-extrabold tracking-widest leading-none">INVOICE</span>
              </div>
              <div class="text-sm font-bold text-rose-600">វិក្កយបត្រ</div>
            </div>
          </div>

          <!-- Divider -->
          <div class="mt-8 h-px w-full bg-rose-100"></div>

          <!-- Bill to + meta -->
          <div class="mt-8 grid grid-cols-2 gap-6">
            <div class="rounded-2xl border border-rose-100 bg-rose-50 p-5">
              <div class="text-xs font-bold tracking-wider text-rose-700 uppercase">
                Bill To <span class="font-normal text-rose-500">/ អតិថិជន</span>
              </div>
              <div id="vCustomer" class="mt-3 text-xl font-bold text-slate-900 min-h-[28px]">
                -
              </div>
            </div>

            <div class="flex justify-end">
              <div class="w-full max-w-sm space-y-3">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-xs font-bold tracking-wider text-slate-500 uppercase whitespace-nowrap">
                    Date <span class="font-normal text-rose-500">/ កាលបរិច្ឆេទ</span>
                  </div>
                  <div id="vDate" class="text-sm font-bold text-slate-800 whitespace-nowrap">
                    -
                  </div>
                </div>

                <div class="flex items-center justify-between gap-3">
                  <div class="text-xs font-bold tracking-wider text-slate-500 uppercase whitespace-nowrap">
                    No <span class="font-normal text-rose-500">/ លេខ</span>
                  </div>
                  <!-- FIXED HEIGHT pill = always centered -->
                  <div class="h-10 px-4 rounded-xl bg-rose-100 text-rose-700 inline-flex items-center justify-center">
                    <span id="vNo" class="font-extrabold whitespace-nowrap">INV-001</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="mt-10 rounded-2xl border border-rose-100 overflow-hidden">
            <div class="bg-rose-50 px-4 py-3 grid grid-cols-[60px,1fr,110px,140px,140px] gap-2 text-xs font-bold text-slate-700">
              <div>#</div>
              <div>Description <span class="font-normal text-rose-500">/ បរិយាយ</span></div>
              <div class="text-center">Qty <span class="font-normal text-rose-500">/ ចំនួន</span></div>
              <div class="text-right">Price <span class="font-normal text-rose-500">/ តម្លៃ</span></div>
              <div class="text-right">Total <span class="font-normal text-rose-500">/ សរុប</span></div>
            </div>

            <div id="rows" class="divide-y divide-rose-100">
              <div class="px-4 py-10 text-center text-slate-400 italic">No items added…</div>
            </div>
          </div>

          <!-- Totals -->
          <div class="mt-8 flex justify-end">
            <div class="w-full max-w-sm flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">
                TOTAL <span class="text-rose-500 font-normal">/ សរុប</span>
              </div>

              <!-- FIXED HEIGHT pill -->
              <div class="h-12 px-6 rounded-2xl bg-rose-600 text-white inline-flex items-center justify-center shadow">
                <span id="vTotal" class="text-xl font-extrabold leading-none">$0.00</span>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="absolute left-14 right-14 bottom-12 flex items-end justify-between">
            <div class="w-[260px]">
              <div class="h-px bg-rose-200"></div>
              <div class="mt-2 text-xs font-bold text-slate-600">
                Seller Signature <span class="font-normal text-rose-500">/ ហត្ថលេខាអ្នកលក់</span>
              </div>
            </div>
            <div class="text-right text-xs text-slate-400">
              <div class="font-bold text-slate-500">Thank you!</div>
              <div class="text-rose-500">សូមអរគុណ!</div>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <script>
    // ===== Config =====
    const SECRET_PIN = "4321";
    const EXPORT_SCALE = 2; // safe for iPhone/Android
    const LOGO_EXPORT_MODE = "jpeg"; // "jpeg" kills moire best, "png" keeps sharp edges

    let items = [];
    let logoExportDataUrl = ""; // preprocessed logo for stable export

    // ===== Login =====
    function checkLogin() {
      const val = document.getElementById("pin").value;
      if (val === SECRET_PIN) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("invDate").valueAsDate = new Date();
        updatePreview();
        renderItems();
      } else {
        document.getElementById("pinErr").classList.remove("hidden");
      }
    }

    // ===== Helpers =====
    function fmtMoney(n) {
      const num = Number(n || 0);
      return "$" + num.toFixed(2);
    }

    function setText(id, v) {
      document.getElementById(id).innerText = v;
    }

    // ===== Preview update =====
    function updatePreview() {
      setText("vShopName", document.getElementById("shopName").value || "Shop Name");
      setText("vShopContact", document.getElementById("shopContact").value || "");
      setText("vCustomer", document.getElementById("customer").value || "-");
      setText("vNo", document.getElementById("invNo").value || "-");

      const d = document.getElementById("invDate").value;
      setText("vDate", d ? new Date(d).toLocaleDateString("en-GB") : "-");
    }

    // ===== Logo processing =====
    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function dataURLToImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function preprocessLogo(file) {
      // The logo box in invoice is h-14 => 56px max height visible.
      // We export at EXPORT_SCALE, so prepare logo at 56*EXPORT_SCALE.
      const targetH = 56 * EXPORT_SCALE;

      const url = await fileToDataURL(file);
      const img = await dataURLToImage(url);

      const scale = targetH / img.naturalHeight;
      const targetW = Math.max(1, Math.round(img.naturalWidth * scale));

      const canvas = document.createElement("canvas");
      canvas.width = targetW;
      canvas.height = targetH;

      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";

      // Tiny blur kills "scratch/moire" on textured logos (especially iOS)
      // If you want zero blur, set to "blur(0px)"
      ctx.filter = "blur(0.35px)";

      ctx.clearRect(0, 0, targetW, targetH);
      ctx.drawImage(img, 0, 0, targetW, targetH);

      // Export logo to JPEG to reduce moire lines (best for textured backgrounds)
      if (LOGO_EXPORT_MODE === "png") {
        return canvas.toDataURL("image/png");
      }
      return canvas.toDataURL("image/jpeg", 0.95);
    }

    document.getElementById("logoInput").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        logoExportDataUrl = await preprocessLogo(file);

        // Show preview
        const logoView = document.getElementById("logoView");
        const fallback = document.getElementById("logoFallback");
        logoView.src = logoExportDataUrl;
        logoView.classList.remove("hidden");
        fallback.classList.add("hidden");
      } catch (err) {
        alert("Logo error: " + err);
        console.error(err);
      }
    });

    // ===== Items =====
    function addItem() {
      const desc = (document.getElementById("itemDesc").value || "").trim();
      const qty = parseFloat(document.getElementById("itemQty").value);
      const price = parseFloat(document.getElementById("itemPrice").value);

      if (!desc || isNaN(qty) || isNaN(price)) {
        alert("Please fill Description, Qty, and Price.");
        return;
      }

      items.push({ desc, qty, price });

      document.getElementById("itemDesc").value = "";
      document.getElementById("itemQty").value = "";
      document.getElementById("itemPrice").value = "";

      renderItems();
    }

    function removeItem(i) {
      items.splice(i, 1);
      renderItems();
    }

    function renderItems() {
      const rows = document.getElementById("rows");
      const list = document.getElementById("itemsList");

      rows.innerHTML = "";
      list.innerHTML = "";

      let total = 0;

      if (items.length === 0) {
        rows.innerHTML = `<div class="px-4 py-10 text-center text-slate-400 italic">No items added…</div>`;
        list.innerHTML = `<p class="text-sm text-slate-400 italic">No items yet.</p>`;
        setText("vTotal", "$0.00");
        return;
      }

      items.forEach((it, idx) => {
        const line = it.qty * it.price;
        total += line;

        // invoice rows
        const row = document.createElement("div");
        row.className = "px-4 py-3 grid grid-cols-[60px,1fr,110px,140px,140px] gap-2 text-sm text-slate-700";
        row.innerHTML = `
          <div class="text-slate-500">${idx + 1}</div>
          <div class="font-semibold">${escapeHtml(it.desc)}</div>
          <div class="text-center text-slate-600">${it.qty}</div>
          <div class="text-right text-slate-600">${fmtMoney(it.price)}</div>
          <div class="text-right font-extrabold text-rose-700">${fmtMoney(line)}</div>
        `;
        rows.appendChild(row);

        // control list
        const c = document.createElement("div");
        c.className = "flex items-center justify-between rounded-2xl border border-rose-100 bg-white p-3 shadow-sm";
        c.innerHTML = `
          <div>
            <div class="font-bold text-slate-800 text-sm">${escapeHtml(it.desc)}</div>
            <div class="text-xs text-slate-500">${it.qty} × ${fmtMoney(it.price)}</div>
          </div>
          <button class="rounded-xl bg-rose-50 px-3 py-1.5 text-xs font-bold text-rose-700 hover:bg-rose-100"
            onclick="removeItem(${idx})">Remove</button>
        `;
        list.appendChild(c);
      });

      setText("vTotal", fmtMoney(total));
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ===== Export =====
    function raf2() {
      return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    }

    async function ensureFonts() {
      try {
        if (document.fonts && document.fonts.ready) {
          await document.fonts.load('16px "Battambang"');
          await document.fonts.load('700 16px "Battambang"');
          await document.fonts.ready;
        }
      } catch (_) {}
    }

    async function waitForImages(root) {
      const imgs = [...root.querySelectorAll("img")];
      await Promise.all(imgs.map(img => {
        if (img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise(res => { img.onload = res; img.onerror = res; });
      }));
    }

    async function downloadImage() {
      const original = document.getElementById("invoice");

      // Create invisible on-screen container (Safari-safe)
      const container = document.createElement("div");
      container.style.position = "fixed";
      container.style.left = "0";
      container.style.top = "0";
      container.style.opacity = "0";
      container.style.pointerEvents = "none";
      container.style.zIndex = "-1";
      document.body.appendChild(container);

      // Clone invoice
      const clone = original.cloneNode(true);
      clone.classList.remove("interactive");

      // lock size / avoid reflow differences
      clone.style.width = getComputedStyle(original).width;
      clone.style.minHeight = getComputedStyle(original).minHeight;
      clone.style.transform = "none";
      clone.style.webkitTransform = "none";
      clone.style.margin = "0";

      container.appendChild(clone);

      try {
        await ensureFonts();
        await waitForImages(clone);
        await raf2();

        const canvas = await html2canvas(clone, {
          scale: EXPORT_SCALE,
          useCORS: true,
          backgroundColor: "#ffffff",
          scrollX: 0,
          scrollY: 0,
          width: clone.scrollWidth,
          height: clone.scrollHeight
        });

        const a = document.createElement("a");
        a.download = `Invoice-${document.getElementById("invNo").value || "INV"}.png`;
        a.href = canvas.toDataURL("image/png");
        a.click();
      } catch (e) {
        alert("Export error: " + e);
        console.error(e);
      } finally {
        document.body.removeChild(container);
      }
    }
  </script>
</body>
</html>
