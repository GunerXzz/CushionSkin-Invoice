<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Maker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- jsPDF (PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Battambang", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    :root{
      --a4w: 794px;
      --a4h: 1123px;
      --pad: 56px;
      --accent: #e11d48; /* rose-600 */
    }

    /* ✅ IMPORTANT FIX:
       Do NOT use !important here, or JS preview scaling won't work on mobile. */
    .paper {
      width: var(--a4w);
      min-height: var(--a4h);
      background: #fff;
      padding: var(--pad);
      position: relative;
      box-sizing: border-box;
      transform: none; /* <-- no !important */
    }

    /* ✅ Export clone only: force no transform (safe for html2canvas) */
    .paper[data-export="1"] {
      transform: none !important;
    }

    /* Export-only: prevent ascender clipping */
    [data-export="1"] .export-safe-top { padding-top: 6px !important; }

    .crisp {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    /* The stage that holds the scaled invoice */
    #previewStage {
      position: relative;
      overflow: hidden;
      background: #fff;
    }
  </style>
</head>

<body class="bg-rose-50">

  <!-- LOGIN -->
  <div id="login" class="fixed inset-0 bg-rose-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center border border-rose-100">
      <h2 class="text-2xl font-bold mb-2 text-slate-800">Invoice Maker</h2>
      <p class="text-slate-500 mb-6 text-sm">Please enter PIN to access.</p>
      <input type="password" id="pin" placeholder="PIN"
        class="w-full border-2 border-rose-100 rounded-xl p-3 text-center text-xl mb-4 focus:border-rose-400 focus:outline-none" />
      <button onclick="checkLogin()"
        class="w-full bg-rose-600 text-white font-bold py-3 rounded-xl hover:bg-rose-700 transition shadow-md">
        LOGIN
      </button>
      <p id="pinErr" class="text-red-500 mt-2 text-sm hidden">Incorrect PIN</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden min-h-screen flex flex-col lg:flex-row">

    <!-- LEFT PANEL -->
    <aside class="w-full lg:w-[380px] bg-white border-r border-rose-100 p-6 overflow-y-auto">
      <div class="mb-6 border-b border-rose-100 pb-4">
        <h2 class="text-lg font-bold text-slate-800">Settings</h2>
        <p class="text-xs text-slate-500">Invoice Maker</p>
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase">Shop</h3>

        <input id="shopName" value="Cushion Skin" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Shop name" />

        <input id="shopContact" value="Tel: 093 838 800 | Phnom Penh" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Contact line" />
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase">Customer</h3>

        <input id="customer" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Customer name (e.g. Mony 012345678)" />

        <input id="invDate" type="date" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400" />
      </div>

      <div class="rounded-2xl border border-rose-100 bg-rose-50 p-4 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase mb-3">Items</h3>

        <input id="itemDesc"
          class="w-full rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400 mb-2"
          placeholder="Description" />

        <div class="grid grid-cols-2 gap-2">
          <input id="itemQty" type="number" inputmode="decimal"
            class="rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400"
            placeholder="Qty" />

          <input id="itemPrice" type="number" inputmode="decimal"
            class="rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400"
            placeholder="Price ($)" />
        </div>

        <button onclick="addItem()"
          class="mt-3 w-full rounded-xl bg-rose-600 py-2.5 font-bold text-white shadow hover:bg-rose-700">
          + Add item
        </button>
      </div>

      <div class="mb-6">
        <h3 class="text-xs font-bold tracking-wider text-slate-500 uppercase mb-2">Current items</h3>
        <div id="itemsList" class="space-y-2">
          <p class="text-sm text-slate-400 italic">No items yet.</p>
        </div>
      </div>

      <div class="space-y-2">
        <button onclick="downloadImage()"
          class="w-full rounded-2xl bg-slate-900 py-3 font-bold text-white shadow hover:bg-slate-950">
          Download Image
        </button>

        <button onclick="viewPdf()"
          class="w-full rounded-2xl bg-white py-3 font-bold text-slate-900 border border-slate-200 shadow hover:bg-slate-50">
          View PDF
        </button>

        <button onclick="downloadPdf()"
          class="w-full rounded-2xl bg-rose-600 py-3 font-bold text-white shadow hover:bg-rose-700">
          Download PDF
        </button>
      </div>

      <p class="mt-3 text-center text-xs text-slate-400">By Sok Chanmony</p>
    </aside>

    <!-- RIGHT PREVIEW -->
    <main class="flex-1 p-4 lg:p-10 bg-rose-100/60 overflow-y-auto">
      <div class="mx-auto w-full lg:w-auto lg:max-w-fit">
        <div id="previewWrap"
             class="w-full lg:w-auto shadow-2xl rounded-2xl overflow-hidden bg-white border border-rose-100">
          <div id="previewStage" class="mx-auto">
            <div id="invoice" class="paper crisp">

              <div class="absolute left-0 top-0 h-2 w-full" style="background: var(--accent);"></div>

              <div class="mt-6 flex items-start justify-between gap-8">
                <div class="min-w-0 export-safe-top">
                  <div id="vShopName" class="text-4xl font-extrabold tracking-tight text-slate-900 leading-[1.15]">
                    Cushion Skin
                  </div>
                  <div id="vShopContact" class="mt-2 text-sm text-slate-500">
                    Tel: 093 838 800 | Phnom Penh
                  </div>
                  <div class="mt-4 h-[3px] w-24 rounded-full" style="background: var(--accent);"></div>
                </div>

                <div class="text-right">
                  <div class="export-safe-top">
                    <div class="text-3xl font-extrabold tracking-[0.2em] text-slate-900 leading-[1.1]">INVOICE</div>
                    <div class="mt-2 text-sm font-bold text-slate-600">វិក្កយបត្រ</div>
                  </div>
                </div>
              </div>

              <div class="mt-10 grid grid-cols-2 gap-6">
                <div class="rounded-2xl border border-slate-200 p-5">
                  <div class="text-xs font-bold tracking-wider text-slate-500 uppercase">
                    Bill To <span class="font-normal text-slate-400">/ អតិថិជន</span>
                  </div>
                  <div id="vCustomer" class="mt-3 text-xl font-bold text-slate-900 min-h-[28px]">-</div>
                </div>

                <div class="rounded-2xl border border-slate-200 p-5">
                  <div class="text-xs font-bold tracking-wider text-slate-500 uppercase">
                    Date <span class="font-normal text-slate-400">/ កាលបរិច្ឆេទ</span>
                  </div>
                  <div id="vDate" class="mt-3 text-xl font-bold text-slate-900 min-h-[28px]">-</div>
                </div>
              </div>

              <div class="mt-10 rounded-2xl border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-4 py-3 grid grid-cols-[60px,1fr,110px,140px,140px] gap-2 text-xs font-bold text-slate-700">
                  <div>#</div>
                  <div>Description <span class="font-normal text-slate-400">/ បរិយាយ</span></div>
                  <div class="text-center">Qty <span class="font-normal text-slate-400">/ ចំនួន</span></div>
                  <div class="text-right">Price <span class="font-normal text-slate-400">/ តម្លៃ</span></div>
                  <div class="text-right">Total <span class="font-normal text-slate-400">/ សរុប</span></div>
                </div>

                <div id="rows" class="divide-y divide-slate-200">
                  <div class="px-4 py-10 text-center text-slate-400 italic">No items added…</div>
                </div>
              </div>

              <div class="mt-10 flex justify-end">
                <div class="w-full max-w-sm rounded-2xl border border-slate-200 p-5">
                  <div class="flex items-center justify-between">
                    <div class="text-sm font-bold text-slate-600">
                      TOTAL <span class="text-slate-400 font-normal">/ សរុប</span>
                    </div>
                    <div id="vTotal" class="text-2xl font-extrabold text-slate-900 leading-[1.1]">$0.00</div>
                  </div>
                  <div class="mt-4 h-[2px] w-full bg-slate-100"></div>
                  <div class="mt-3 text-xs text-slate-400 text-right">Thank you / សូមអរគុណ!</div>
                </div>
              </div>

              <div class="mt-14 flex items-end justify-between">
                <div class="w-[280px]">
                  <div class="h-px bg-slate-300"></div>
                  <div class="mt-2 text-xs font-bold text-slate-600">
                    Seller Signature <span class="font-normal text-slate-400">/ ហត្ថលេខាអ្នកលក់</span>
                  </div>
                </div>
                <div class="text-right text-xs text-slate-400"></div>
              </div>

            </div><!-- /invoice -->
          </div><!-- /previewStage -->
        </div><!-- /previewWrap -->
      </div>
    </main>
  </div>

  <script>
    const SECRET_PIN = "4321";
    const EXPORT_SCALE = 2;

    const BASE_W = 794;
    const BASE_H = 1123;

    let items = [];

    function checkLogin() {
      const val = document.getElementById("pin").value;
      if (val === SECRET_PIN) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("invDate").valueAsDate = new Date();
        updatePreview();
        renderItems();
        requestAnimationFrame(() => requestAnimationFrame(updatePreviewScale));
      } else {
        document.getElementById("pinErr").classList.remove("hidden");
      }
    }

    function setText(id, v) { document.getElementById(id).innerText = v; }
    function fmtMoney(n) { return "$" + Number(n || 0).toFixed(2); }

    function updatePreview() {
      setText("vShopName", document.getElementById("shopName").value || "Shop Name");
      setText("vShopContact", document.getElementById("shopContact").value || "");
      setText("vCustomer", document.getElementById("customer").value || "-");
      const d = document.getElementById("invDate").value;
      setText("vDate", d ? new Date(d).toLocaleDateString("en-GB") : "-");
      updatePreviewScale();
    }

    // ✅ Mobile responsive preview scaling now works because .paper transform is not !important.
    function updatePreviewScale() {
      const wrap = document.getElementById("previewWrap");
      const stage = document.getElementById("previewStage");
      const paper = document.getElementById("invoice");
      if (!wrap || !stage || !paper) return;

      const isMobile = window.matchMedia("(max-width: 1024px)").matches;

      paper.style.transformOrigin = "top left";

      if (!isMobile) {
        paper.style.transform = "scale(1)";
        stage.style.width = BASE_W + "px";
        stage.style.height = BASE_H + "px";
        stage.style.overflow = "visible";
        stage.style.margin = "0";
        return;
      }

      const pad = 16;
      const availW = Math.max(260, wrap.clientWidth - pad * 2);

      const rect = wrap.getBoundingClientRect();
      const availH = Math.max(320, window.innerHeight - rect.top - pad * 2);

      let scale = Math.min(availW / BASE_W, availH / BASE_H, 1);
      scale = Math.max(0.22, scale);

      paper.style.transform = `scale(${scale})`;
      stage.style.width = Math.round(BASE_W * scale) + "px";
      stage.style.height = Math.round(BASE_H * scale) + "px";
      stage.style.margin = "0 auto";
      stage.style.overflow = "hidden";
    }

    window.addEventListener("resize", updatePreviewScale);
    window.addEventListener("orientationchange", () => setTimeout(updatePreviewScale, 250));

    // --- Items ---
    function addItem() {
      const desc = (document.getElementById("itemDesc").value || "").trim();
      const qty = parseFloat(document.getElementById("itemQty").value);
      const price = parseFloat(document.getElementById("itemPrice").value);

      if (!desc || isNaN(qty) || isNaN(price)) {
        alert("Please fill Description, Qty, and Price.");
        return;
      }

      items.push({ desc, qty, price });
      document.getElementById("itemDesc").value = "";
      document.getElementById("itemQty").value = "";
      document.getElementById("itemPrice").value = "";
      renderItems();
    }

    function removeItem(i) {
      items.splice(i, 1);
      renderItems();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderItems() {
      const rows = document.getElementById("rows");
      const list = document.getElementById("itemsList");

      rows.innerHTML = "";
      list.innerHTML = "";

      let total = 0;

      if (items.length === 0) {
        rows.innerHTML = `<div class="px-4 py-10 text-center text-slate-400 italic">No items added…</div>`;
        list.innerHTML = `<p class="text-sm text-slate-400 italic">No items yet.</p>`;
        setText("vTotal", "$0.00");
        return;
      }

      items.forEach((it, idx) => {
        const line = it.qty * it.price;
        total += line;

        const row = document.createElement("div");
        row.className = "px-4 py-3 grid grid-cols-[60px,1fr,110px,140px,140px] gap-2 text-sm text-slate-700";
        row.innerHTML = `
          <div class="text-slate-500">${idx + 1}</div>
          <div class="font-semibold">${escapeHtml(it.desc)}</div>
          <div class="text-center text-slate-600">${it.qty}</div>
          <div class="text-right text-slate-600">${fmtMoney(it.price)}</div>
          <div class="text-right font-extrabold" style="color: var(--accent);">${fmtMoney(line)}</div>
        `;
        rows.appendChild(row);

        const c = document.createElement("div");
        c.className = "flex items-center justify-between rounded-2xl border border-rose-100 bg-white p-3 shadow-sm";
        c.innerHTML = `
          <div>
            <div class="font-bold text-slate-800 text-sm">${escapeHtml(it.desc)}</div>
            <div class="text-xs text-slate-500">${it.qty} × ${fmtMoney(it.price)}</div>
          </div>
          <button class="rounded-xl bg-rose-50 px-3 py-1.5 text-xs font-bold text-rose-700 hover:bg-rose-100"
            onclick="removeItem(${idx})">Remove</button>
        `;
        list.appendChild(c);
      });

      setText("vTotal", fmtMoney(total));
    }

    // --- Export helpers (PNG + PDF) ---
    function raf2() {
      return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    }

    async function ensureFonts() {
      try {
        if (document.fonts && document.fonts.ready) {
          await document.fonts.load('16px "Battambang"');
          await document.fonts.load('700 16px "Battambang"');
          await document.fonts.ready;
        }
      } catch (_) {}
    }

    function cropCanvas(srcCanvas, padScaled) {
      const w = srcCanvas.width - padScaled * 2;
      const h = srcCanvas.height - padScaled * 2;
      const out = document.createElement("canvas");
      out.width = Math.max(1, w);
      out.height = Math.max(1, h);
      const ctx = out.getContext("2d");
      ctx.drawImage(srcCanvas, padScaled, padScaled, w, h, 0, 0, w, h);
      return out;
    }

    async function buildExportCanvas() {
      const original = document.getElementById("invoice");

      const container = document.createElement("div");
      container.style.position = "fixed";
      container.style.left = "0";
      container.style.top = "-100000px";
      container.style.background = "#ffffff";
      container.style.zIndex = "-1";
      document.body.appendChild(container);

      const pad = 10;
      const frame = document.createElement("div");
      frame.style.background = "#ffffff";
      frame.style.padding = pad + "px";
      frame.style.display = "inline-block";
      frame.style.boxSizing = "border-box";
      container.appendChild(frame);

      const clone = original.cloneNode(true);
      clone.setAttribute("data-export", "1");

      // Force export size + transform none (with important)
      clone.style.width = BASE_W + "px";
      clone.style.minHeight = BASE_H + "px";
      clone.style.margin = "0";
      clone.style.boxSizing = "border-box";
      clone.style.transformOrigin = "top left";
      clone.style.setProperty("transform", "none", "important");
      clone.style.setProperty("-webkit-transform", "none", "important");

      frame.appendChild(clone);

      try {
        await ensureFonts();
        await raf2();
        await new Promise(r => setTimeout(r, 80));

        const canvas = await html2canvas(frame, {
          scale: EXPORT_SCALE,
          useCORS: true,
          backgroundColor: "#ffffff",
          scrollX: 0,
          scrollY: 0,
          width: frame.scrollWidth,
          height: frame.scrollHeight,
        });

        const scaleX = canvas.width / frame.scrollWidth;
        const padScaled = Math.round(pad * scaleX);
        return cropCanvas(canvas, padScaled);
      } finally {
        document.body.removeChild(container);
      }
    }

    async function downloadImage() {
      try {
        const canvas = await buildExportCanvas();
        const a = document.createElement("a");
        a.download = "Invoice.png";
        a.href = canvas.toDataURL("image/png");
        a.click();
      } catch (e) {
        alert("Export error: " + e);
        console.error(e);
      }
    }

    async function makePdfBlob() {
      const canvas = await buildExportCanvas();
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
      pdf.addImage(imgData, "PNG", 0, 0, 210, 297);
      return pdf.output("blob");
    }

    async function viewPdf() {
      try {
        const blob = await makePdfBlob();
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } catch (e) {
        alert("PDF error: " + e);
        console.error(e);
      }
    }

    async function downloadPdf() {
      try {
        const blob = await makePdfBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Invoice.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } catch (e) {
        alert("PDF error: " + e);
        console.error(e);
      }
    }
  </script>
</body>
</html>
