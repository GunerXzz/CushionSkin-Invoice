<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Maker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Battambang", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* A4 in PX (stable for html2canvas/iOS Safari) */
    :root{
      --a4w: 794px;
      --a4h: 1123px;
      --pad: 56px;
      --accent: #e11d48; /* rose-600 */
    }

    .paper {
      width: var(--a4w);
      min-height: var(--a4h);
      background: #fff;
      padding: var(--pad);
      position: relative;
      box-sizing: border-box;
      transform: none !important;
    }

    /* Mobile preview scaling only */
    @media (max-width: 900px) {
      .paper.interactive {
        transform-origin: top left;
        transform: scale(0.50) !important;
        margin-bottom: -520px;
      }
      .previewWrap {
        height: 560px;
        overflow: hidden;
        border-radius: 16px;
      }
    }

    /* Export-only: add tiny extra top padding to avoid font ascender clipping */
    [data-export="1"] .export-safe-top { padding-top: 6px !important; }

    /* Make text rendering a bit more consistent */
    .crisp {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
  </style>
</head>

<body class="bg-rose-50">

  <!-- LOGIN -->
  <div id="login" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-rose-50">
    <div class="w-full max-w-sm rounded-2xl bg-white shadow-xl border border-rose-100 p-7 text-center">
      <div class="mx-auto mb-3 h-10 w-10 rounded-xl bg-rose-100 flex items-center justify-center text-rose-600 font-bold">
        IM
      </div>
      <h1 class="text-2xl font-bold text-slate-800">Invoice Maker</h1>
      <p class="mt-1 text-sm text-slate-500">Enter PIN to continue</p>

      <input id="pin" type="password" placeholder="PIN"
        class="mt-5 w-full rounded-xl border-2 border-rose-100 px-4 py-3 text-center text-xl outline-none focus:border-rose-400" />

      <button onclick="checkLogin()"
        class="mt-4 w-full rounded-xl bg-rose-600 py-3 font-bold text-white shadow hover:bg-rose-700">
        Login
      </button>

      <p id="pinErr" class="mt-3 text-sm text-red-500 hidden">Wrong PIN</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden min-h-screen flex flex-col lg:flex-row">

    <!-- LEFT PANEL -->
    <aside class="w-full lg:w-[380px] bg-white border-r border-rose-100 p-6 overflow-y-auto">
      <div class="mb-6">
        <h2 class="text-lg font-bold text-slate-800">Settings</h2>
        <p class="text-xs text-slate-500">Modern clean style (export-safe)</p>
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase">Shop</h3>

        <input id="shopName" value="Cushion Skin" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Shop name" />

        <input id="shopContact" value="Tel: 012 345 678 | Phnom Penh" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Contact line" />
      </div>

      <div class="space-y-3 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase">Customer</h3>

        <input id="customer" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400"
          placeholder="Customer name (e.g. Mony 012345678)" />

        <input id="invDate" type="date" oninput="updatePreview()"
          class="w-full rounded-xl border-2 border-rose-100 px-4 py-2.5 outline-none focus:border-rose-400" />
      </div>

      <div class="rounded-2xl border border-rose-100 bg-rose-50 p-4 mb-6">
        <h3 class="text-xs font-bold tracking-wider text-rose-700 uppercase mb-3">Items</h3>

        <input id="itemDesc"
          class="w-full rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400 mb-2"
          placeholder="Description" />

        <div class="grid grid-cols-2 gap-2">
          <input id="itemQty" type="number" inputmode="decimal"
            class="rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400"
            placeholder="Qty" />

          <input id="itemPrice" type="number" inputmode="decimal"
            class="rounded-xl border border-rose-200 px-4 py-2.5 outline-none focus:border-rose-400"
            placeholder="Price ($)" />
        </div>

        <button onclick="addItem()"
          class="mt-3 w-full rounded-xl bg-rose-600 py-2.5 font-bold text-white shadow hover:bg-rose-700">
          + Add item
        </button>
      </div>

      <div class="mb-6">
        <h3 class="text-xs font-bold tracking-wider text-slate-500 uppercase mb-2">Current items</h3>
        <div id="itemsList" class="space-y-2">
          <p class="text-sm text-slate-400 italic">No items yet.</p>
        </div>
      </div>

      <button onclick="downloadImage()"
        class="w-full rounded-2xl bg-slate-900 py-3 font-bold text-white shadow hover:bg-slate-950">
        Download Image
      </button>
      <p class="mt-2 text-center text-xs text-slate-400">By Sok Chanmony</p>
    </aside>

    <!-- RIGHT PREVIEW -->
    <main class="flex-1 p-4 lg:p-10 bg-rose-100/60 overflow-y-auto">
      <div class="previewWrap mx-auto max-w-fit shadow-2xl rounded-2xl overflow-hidden bg-white">
        <div id="invoice" class="paper interactive crisp">

          <!-- Accent line -->
          <div class="absolute left-0 top-0 h-2 w-full" style="background: var(--accent);"></div>

          <!-- Header (no pills) -->
          <div class="mt-6 flex items-start justify-between gap-8">
            <div class="min-w-0 export-safe-top">
              <div id="vShopName"
                   class="text-4xl font-extrabold tracking-tight text-slate-900 leading-[1.15]">
                Cushion Skin
              </div>
              <div id="vShopContact" class="mt-2 text-sm text-slate-500">
                Tel: 012 345 678 | Phnom Penh
              </div>

              <!-- small accent underline -->
              <div class="mt-4 h-[3px] w-24 rounded-full" style="background: var(--accent);"></div>
            </div>

            <div class="text-right">
              <div class="export-safe-top">
                <div class="text-3xl font-extrabold tracking-[0.2em] text-slate-900 leading-[1.1]">
                  INVOICE
                </div>
                <div class="mt-2 text-sm font-bold text-slate-600">
                  វិក្កយបត្រ
                </div>
              </div>
            </div>
          </div>

          <!-- Info row -->
          <div class="mt-10 grid grid-cols-2 gap-6">
            <div class="rounded-2xl border border-slate-200 p-5">
              <div class="text-xs font-bold tracking-wider text-slate-500 uppercase">
                Bill To <span class="font-normal text-slate-400">/ អតិថិជន</span>
              </div>
              <div id="vCustomer" class="mt-3 text-xl font-bold text-slate-900 min-h-[28px]">
                -
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 p-5">
              <div class="text-xs font-bold tracking-wider text-slate-500 uppercase">
                Date <span class="font-normal text-slate-400">/ កាលបរិច្ឆេទ</span>
              </div>
              <div id="vDate" class="mt-3 text-xl font-bold text-slate-900 min-h-[28px]">
                -
              </div>
            </div>
          </div>

          <!-- Items table (simple, export-safe) -->
          <div class="mt-10 rounded-2xl border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 px-4 py-3 grid grid-cols-[60px,1fr,110px,140px,140px] gap-2 text-xs font-bold text-slate-700">
              <div>#</div>
              <div>Description <span class="font-normal text-slate-400">/ បរិយាយ</span></div>
              <div class="text-center">Qty <span class="font-normal text-slate-400">/ ចំនួន</span></div>
              <div class="text-right">Price <span class="font-normal text-slate-400">/ តម្លៃ</span></div>
              <div class="text-right">Total <span class="font-normal text-slate-400">/ សរុប</span></div>
            </div>

            <div id="rows" class="divide-y divide-slate-200">
              <div class="px-4 py-10 text-center text-slate-400 italic">No items added…</div>
            </div>
          </div>

          <!-- Total (no pill background) -->
          <div class="mt-10 flex justify-end">
            <div class="w-full max-w-sm rounded-2xl border border-slate-200 p-5">
              <div class="flex items-center justify-between">
                <div class="text-sm font-bold text-slate-600">
                  TOTAL <span class="text-slate-400 font-normal">/ សរុប</span>
                </div>
                <div id="vTotal" class="text-2xl font-extrabold text-slate-900 leading-[1.1]">
                  $0.00
                </div>
              </div>
              <div class="mt-4 h-[2px] w-full bg-slate-100"></div>
              <div class="mt-3 text-xs text-slate-400 text-right">
                Thank you / សូមអរគុណ!
              </div>
            </div>
          </div>

          <!-- Footer (NOT absolute to avoid export clipping) -->
          <div class="mt-14 flex items-end justify-between">
            <div class="w-[280px]">
              <div class="h-px bg-slate-300"></div>
              <div class="mt-2 text-xs font-bold text-slate-600">
                Seller Signature <span class="font-normal text-slate-400">/ ហត្ថលេខាអ្នកលក់</span>
              </div>
            </div>

            <div class="text-right text-xs text-slate-400">
              Generated by Invoice Maker
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <script>
    const SECRET_PIN = "4321";
    const EXPORT_SCALE = 2;

    let items = [];

    function checkLogin() {
      const val = document.getElementById("pin").value;
      if (val === SECRET_PIN) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("invDate").valueAsDate = new Date();
        updatePreview();
        renderItems();
      } else {
        document.getElementById("pinErr").classList.remove("hidden");
      }
    }

    function fmtMoney(n) {
      const num = Number(n || 0);
      return "$" + num.toFixed(2);
    }

    function setText(id, v) {
      document.getElementById(id).innerText = v;
    }

    function updatePreview() {
      setText("vShopName", document.getElementById("shopName").value || "Shop Name");
      setText("vShopContact", document.getElementById("shopContact").value || "");
      setText("vCustomer", document.getElementById("customer").value || "-");

      const d = document.getElementById("invDate").value;
      setText("vDate", d ? new Date(d).toLocaleDateString("en-GB") : "-");
    }

    function addItem() {
      const desc = (document.getElementById("itemDesc").value || "").trim();
      const qty = parseFloat(document.getElementById("itemQty").value);
      const price = parseFloat(document.getElementById("itemPrice").value);

      if (!desc || isNaN(qty) || isNaN(price)) {
        alert("Please fill Description, Qty, and Price.");
        return;
      }

      items.push({ desc, qty, price });

      document.getElementById("itemDesc").value = "";
      document.getElementById("itemQty").value = "";
      document.getElementById("itemPrice").value = "";

      renderItems();
    }

    function removeItem(i) {
      items.splice(i, 1);
      renderItems();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderItems() {
      const rows = document.getElementById("rows");
      const list = document.getElementById("itemsList");

      rows.innerHTML = "";
      list.innerHTML = "";

      let total = 0;

      if (items.length === 0) {
        rows.innerHTML = `<div class="px-4 py-10 text-center text-slate-400 italic">No items added…</div>`;
        list.innerHTML = `<p class="text-sm text-slate-400 italic">No items yet.</p>`;
        setText("vTotal", "$0.00");
        return;
      }

      items.forEach((it, idx) => {
        const line = it.qty * it.price;
        total += line;

        const row = document.createElement("div");
        row.className = "px-4 py-3 grid grid-cols-[60px,1fr,110px,140px,140px] gap-2 text-sm text-slate-700";
        row.innerHTML = `
          <div class="text-slate-500">${idx + 1}</div>
          <div class="font-semibold">${escapeHtml(it.desc)}</div>
          <div class="text-center text-slate-600">${it.qty}</div>
          <div class="text-right text-slate-600">${fmtMoney(it.price)}</div>
          <div class="text-right font-extrabold" style="color: var(--accent);">${fmtMoney(line)}</div>
        `;
        rows.appendChild(row);

        const c = document.createElement("div");
        c.className = "flex items-center justify-between rounded-2xl border border-rose-100 bg-white p-3 shadow-sm";
        c.innerHTML = `
          <div>
            <div class="font-bold text-slate-800 text-sm">${escapeHtml(it.desc)}</div>
            <div class="text-xs text-slate-500">${it.qty} × ${fmtMoney(it.price)}</div>
          </div>
          <button class="rounded-xl bg-rose-50 px-3 py-1.5 text-xs font-bold text-rose-700 hover:bg-rose-100"
            onclick="removeItem(${idx})">Remove</button>
        `;
        list.appendChild(c);
      });

      setText("vTotal", fmtMoney(total));
    }

    function raf2() {
      return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    }

    async function ensureFonts() {
      try {
        if (document.fonts && document.fonts.ready) {
          await document.fonts.load('16px "Battambang"');
          await document.fonts.load('700 16px "Battambang"');
          await document.fonts.ready;
        }
      } catch (_) {}
    }

    function cropCanvas(srcCanvas, padScaled) {
      const w = srcCanvas.width - padScaled * 2;
      const h = srcCanvas.height - padScaled * 2;
      const out = document.createElement("canvas");
      out.width = Math.max(1, w);
      out.height = Math.max(1, h);
      const ctx = out.getContext("2d");
      ctx.drawImage(srcCanvas, padScaled, padScaled, w, h, 0, 0, w, h);
      return out;
    }

    async function downloadImage() {
      const original = document.getElementById("invoice");

      // Offscreen (NOT opacity 0). Opacity 0 can cause weird render/cut in some cases.
      const container = document.createElement("div");
      container.style.position = "fixed";
      container.style.left = "0";
      container.style.top = "-100000px";
      container.style.background = "#ffffff";
      container.style.zIndex = "-1";
      document.body.appendChild(container);

      const pad = 10; // safety padding
      const frame = document.createElement("div");
      frame.style.background = "#ffffff";
      frame.style.padding = pad + "px";
      frame.style.display = "inline-block";
      frame.style.boxSizing = "border-box";
      container.appendChild(frame);

      const clone = original.cloneNode(true);
      clone.classList.remove("interactive");
      clone.setAttribute("data-export", "1"); // enable export-only top padding

      // lock size
      clone.style.width = getComputedStyle(original).width;
      clone.style.minHeight = getComputedStyle(original).minHeight;
      clone.style.transform = "none";
      clone.style.webkitTransform = "none";
      clone.style.margin = "0";
      clone.style.boxSizing = "border-box";

      frame.appendChild(clone);

      try {
        await ensureFonts();
        await raf2();
        await new Promise(r => setTimeout(r, 80)); // small settle time

        const canvas = await html2canvas(frame, {
          scale: EXPORT_SCALE,
          useCORS: true,
          backgroundColor: "#ffffff",
          scrollX: 0,
          scrollY: 0,
          width: frame.scrollWidth,
          height: frame.scrollHeight,
        });

        // Compute actual pad scaling (fixes wrong crop on different DPR/devices)
        const scaleX = canvas.width / frame.scrollWidth;
        const padScaled = Math.round(pad * scaleX);

        const cropped = cropCanvas(canvas, padScaled);

        const a = document.createElement("a");
        a.download = "Invoice.png";
        a.href = cropped.toDataURL("image/png");
        a.click();
      } catch (e) {
        alert("Export error: " + e);
        console.error(e);
      } finally {
        document.body.removeChild(container);
      }
    }
  </script>
</body>
</html>
