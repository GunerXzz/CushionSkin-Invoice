<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Maker</title>
    
    <!-- Tailwind CSS for Layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTML2Canvas for Image Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Battambang (Main) -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Battambang', cursive; 
            background-color: #fdf2f8; /* Light pink background */
        }

        /* The Invoice Paper - Fixed A4 Ratio Logic */
        #invoice-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            margin: 0 auto;
            box-shadow: 0 10px 15px -3px rgba(236, 72, 153, 0.1), 0 4px 6px -2px rgba(236, 72, 153, 0.05); /* Pink shadow */
            position: relative;
            color: #374151; /* Gray-700 text */
        }

        .cute-table th {
            font-weight: 700;
            color: #be185d; 
        }
        
        .cute-table th:first-child {
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }
        .cute-table th:last-child {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        /* Mobile Responsive Scaling for the Preview UI ONLY */
        .preview-container {
            overflow: auto;
            border: 1px solid #fbcfe8; 
            background: #fce7f3;
            padding: 10px;
        }

        /* On mobile screen, we scale visually, but this won't affect the download anymore */
        @media (max-width: 800px) {
            #invoice-preview {
                transform-origin: top left;
                transform: scale(0.45); 
                margin-bottom: -150mm; 
            }
            .preview-container {
                height: 500px; 
                overflow: hidden; 
            }
        }
    </style>
</head>
<body>

    <!-- ================= LOGIN OVERLAY ================= -->
    <div id="login-screen" class="fixed inset-0 bg-pink-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center border-2 border-pink-100">
            <h2 class="text-2xl font-bold mb-2 text-pink-600">Welcome</h2>
            <p class="text-pink-400 mb-6 text-sm">Please enter PIN to access.</p>
            <input type="password" id="pin-input" placeholder="PIN" class="w-full border-2 border-pink-200 rounded-xl p-3 text-center text-xl mb-4 focus:border-pink-500 focus:outline-none text-pink-600" />
            <button onclick="checkLogin()" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl hover:bg-pink-600 transition shadow-md">LOGIN</button>
            <p id="error-msg" class="text-red-500 mt-2 text-sm hidden">Incorrect PIN</p>
        </div>
    </div>

    <!-- ================= MAIN APP ================= -->
    <div id="app-content" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <!-- LEFT: CONTROLS & INPUTS -->
        <div class="w-full md:w-1/3 bg-white p-6 overflow-y-auto border-r border-pink-100 h-screen-dynamic">
            <div class="mb-6 border-b border-pink-100 pb-4">
                <h1 class="text-xl font-bold text-pink-600">Invoice Settings</h1>
                <p class="text-xs text-pink-400">Customize your invoice below.</p>
            </div>

            <!-- Company Info -->
            <div class="space-y-3 mb-6">
                <h3 class="font-bold text-sm text-pink-500 uppercase tracking-wider">My Shop</h3>
                <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-pink-500 file:mr-4 file:py-2 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100"/>
                <input type="text" id="company-name" placeholder="Shop Name" class="w-full border-2 border-pink-100 p-2 rounded-lg focus:border-pink-400 outline-none" oninput="updatePreview()" value="My Shop">
                <input type="text" id="company-contact" placeholder="Address / Phone" class="w-full border-2 border-pink-100 p-2 rounded-lg focus:border-pink-400 outline-none" oninput="updatePreview()" value="Tel: 012 345 678 | Phnom Penh">
            </div>

            <!-- Invoice Info -->
            <div class="space-y-3 mb-6">
                <h3 class="font-bold text-sm text-pink-500 uppercase tracking-wider">Customer Info</h3>
                <input type="text" id="customer-name" placeholder="Customer Name" class="w-full border-2 border-pink-100 p-2 rounded-lg focus:border-pink-400 outline-none" oninput="updatePreview()">
                <input type="date" id="invoice-date" class="w-full border-2 border-pink-100 p-2 rounded-lg focus:border-pink-400 outline-none" oninput="updatePreview()">
                <input type="text" id="invoice-no" placeholder="Invoice No." class="w-full border-2 border-pink-100 p-2 rounded-lg focus:border-pink-400 outline-none" oninput="updatePreview()" value="INV-001">
            </div>

            <!-- Add Items -->
            <div class="bg-pink-50 p-4 rounded-xl border border-pink-200 mb-6">
                <h3 class="font-bold text-sm text-pink-600 uppercase mb-3">Add Items</h3>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="item-desc" placeholder="Description" class="col-span-2 border border-pink-200 p-2 rounded-lg focus:outline-none focus:border-pink-400">
                    <input type="number" id="item-qty" placeholder="Qty" class="border border-pink-200 p-2 rounded-lg focus:outline-none focus:border-pink-400">
                    <input type="number" id="item-price" placeholder="Price ($)" class="border border-pink-200 p-2 rounded-lg focus:outline-none focus:border-pink-400">
                </div>
                <button onclick="addItem()" class="w-full bg-pink-500 text-white font-bold py-2 rounded-lg hover:bg-pink-600 transition shadow-sm">+ Add Item</button>
            </div>

            <!-- Items List Management -->
            <div class="mb-6">
                <h3 class="font-bold text-sm text-gray-400 mb-2">Current Items</h3>
                <div id="items-control-list" class="space-y-2">
                    <p class="text-sm text-gray-400 italic">No items added yet.</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="pt-4 border-t border-pink-100">
                <button onclick="downloadImage()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-900 transition flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download Image
                </button>
                <p class="text-xs text-center text-gray-400 mt-2">By Sok Chanmony</p>
            </div>
        </div>

        <!-- RIGHT: PREVIEW AREA -->
        <div class="w-full md:w-2/3 bg-pink-100 flex justify-center p-4 md:p-10 overflow-y-auto">
            
            <div class="preview-container rounded-xl shadow-2xl">
                <!-- THE ACTUAL INVOICE PAPER (Target for html2canvas) -->
                <div id="invoice-preview" class="leading-tight">
                    
                    <!-- Top Decoration Line -->
                    <div class="absolute top-0 left-0 right-0 h-2 bg-pink-400"></div>

                    <!-- Header -->
                    <div class="flex justify-between items-start mb-8 mt-4">
                        <div class="flex flex-col">
                            <!-- Logo Placeholder -->
                            <img id="display-logo" src="" alt="Logo" class="h-24 w-auto object-contain mb-3 hidden" />
                            
                            <!-- Main Shop Name -->
                            <h2 id="display-company-en" class="text-3xl font-bold text-pink-600 tracking-tight">SHOP NAME</h2>
                            
                            <!-- Contact Info -->
                            <p id="display-contact" class="text-sm text-gray-500 mt-1 font-medium">Tel: 012 345 678</p>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <div class="bg-pink-500 text-white rounded-full px-6 py-2 shadow-sm inline-block mb-1">
                                <h1 class="text-3xl font-bold tracking-widest">INVOICE</h1>
                            </div>
                            <h2 class="text-lg text-pink-400 font-bold pr-2">វិក្កយបត្រ</h2>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="w-full h-px bg-pink-100 mb-8"></div>

                    <!-- Info Grid -->
                    <div class="flex justify-between mb-8">
                        <div class="bg-pink-50 p-4 rounded-lg border border-pink-100 w-1/2 mr-4">
                            <p class="text-pink-400 text-xs font-bold uppercase mb-1">Bill To / អតិថិជន:</p>
                            <h3 id="display-customer" class="text-xl font-bold text-gray-700 min-h-[1.5rem]">-</h3>
                        </div>
                        <div class="text-right flex flex-col justify-center">
                            <div class="mb-2">
                                <span class="text-pink-400 text-xs font-bold uppercase">Date / កាលបរិច្ឆេទ:</span>
                                <span id="display-date" class="font-bold text-gray-600 ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-pink-400 text-xs font-bold uppercase">No / លេខ:</span>
                                <span id="display-no" class="font-bold text-pink-600 ml-2 bg-pink-100 px-2 py-1 rounded">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <table class="w-full mb-8 border-separate border-spacing-y-2 cute-table">
                        <thead>
                            <tr class="bg-pink-100">
                                <th class="py-3 px-3 text-left w-12 text-sm">#</th>
                                <th class="py-3 px-3 text-left text-sm">
                                    Description <br> <span class="font-normal text-xs text-pink-400">បរិយាយ</span>
                                </th>
                                <th class="py-3 px-3 text-center w-24 text-sm">
                                    Qty <br> <span class="font-normal text-xs text-pink-400">ចំនួន</span>
                                </th>
                                <th class="py-3 px-3 text-right w-32 text-sm">
                                    Price <br> <span class="font-normal text-xs text-pink-400">តម្លៃ</span>
                                </th>
                                <th class="py-3 px-3 text-right w-32 text-sm">
                                    Total <br> <span class="font-normal text-xs text-pink-400">សរុប</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items-body">
                            <!-- Items will be injected here -->
                            <tr>
                                <td colspan="5" class="py-8 text-center text-pink-300 italic">No items...</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td class="pt-4 text-right font-bold text-pink-400 uppercase pr-4 text-sm">Total / សរុប:</td>
                                <td class="pt-4 text-right">
                                    <div class="bg-pink-500 text-white font-bold text-xl py-2 px-4 rounded-lg shadow-sm inline-block" id="display-grand-total">
                                        $0.00
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Footer -->
                    <div class="absolute bottom-10 left-10 right-10 flex justify-between items-end">
                        <div class="text-center w-1/3">
                            <div class="border-b-2 border-pink-200 w-full mb-2"></div>
                            <p class="text-xs text-pink-400 font-bold">Seller Signature / ហត្ថលេខាអ្នកលក់</p>
                        </div>
                        <div class="text-right text-xs text-gray-400">
                            <p>Thank you!</p>
                            <p class="text-pink-300">សូមអរគុណ!</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        const SECRET_PIN = "4321"; // User's PIN
        let items = [];

        // --- 2. LOGIN LOGIC ---
        function checkLogin() {
            const input = document.getElementById('pin-input').value;
            if(input === SECRET_PIN) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                
                // Set Default Date
                document.getElementById('invoice-date').valueAsDate = new Date();
                updatePreview();
            } else {
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        // --- 3. PREVIEW UPDATER ---
        function updatePreview() {
            setText('display-company-en', document.getElementById('company-name').value);
            setText('display-contact', document.getElementById('company-contact').value);
            setText('display-customer', document.getElementById('customer-name').value || "-");
            setText('display-no', document.getElementById('invoice-no').value);

            // Date formatting
            const dateVal = document.getElementById('invoice-date').value;
            setText('display-date', dateVal ? new Date(dateVal).toLocaleDateString('en-GB') : "-");
        }

        function setText(id, val) {
            document.getElementById(id).innerText = val;
        }

        // --- 4. LOGO HANDLING ---
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('display-logo');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // --- 5. ITEM LOGIC ---
        function addItem() {
            const desc = document.getElementById('item-desc').value;
            const qty = parseFloat(document.getElementById('item-qty').value);
            const price = parseFloat(document.getElementById('item-price').value);

            if (!desc || isNaN(qty) || isNaN(price)) {
                alert("Please fill in Description, Qty, and Price");
                return;
            }

            items.push({ desc, qty, price });
            
            // Clear inputs
            document.getElementById('item-desc').value = '';
            document.getElementById('item-qty').value = '';
            document.getElementById('item-price').value = '';

            renderItems();
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
        }

        function renderItems() {
            const tbody = document.getElementById('invoice-items-body');
            const controlList = document.getElementById('items-control-list');
            
            tbody.innerHTML = '';
            controlList.innerHTML = '';
            
            let grandTotal = 0;

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-pink-300 italic">No items added...</td></tr>';
                controlList.innerHTML = '<p class="text-sm text-gray-400 italic">No items added yet.</p>';
            }

            items.forEach((item, index) => {
                const total = item.qty * item.price;
                grandTotal += total;

                // 1. Update Preview Table
                const tr = document.createElement('tr');
                tr.className = "hover:bg-pink-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 px-3 text-left text-gray-500 border-b border-gray-100">${index + 1}</td>
                    <td class="py-3 px-3 text-left text-gray-700 font-medium border-b border-gray-100">${item.desc}</td>
                    <td class="py-3 px-3 text-center text-gray-500 border-b border-gray-100">${item.qty}</td>
                    <td class="py-3 px-3 text-right text-gray-500 border-b border-gray-100">$${item.price.toFixed(2)}</td>
                    <td class="py-3 px-3 text-right text-pink-600 font-bold border-b border-gray-100">$${total.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);

                // 2. Update Control List (Mobile friendly list)
                const controlItem = document.createElement('div');
                controlItem.className = "flex justify-between items-center bg-white p-3 rounded-xl border border-pink-100 shadow-sm";
                controlItem.innerHTML = `
                    <div class="text-sm">
                        <div class="font-bold text-gray-700">${item.desc}</div>
                        <div class="text-pink-400 text-xs">${item.qty} x $${item.price.toFixed(2)}</div>
                    </div>
                    <button onclick="removeItem(${index})" class="text-red-400 hover:text-red-600 text-xs font-bold px-3 py-1 bg-red-50 rounded-lg">Remove</button>
                `;
                controlList.appendChild(controlItem);
            });

            document.getElementById('display-grand-total').innerText = '$' + grandTotal.toFixed(2);
        }

        // --- 6. "CLONE & CAPTURE" EXPORT LOGIC (FIXED) ---
        function downloadImage() {
            const originalInvoice = document.getElementById('invoice-preview');

            // 1. Create a container to hold the clone off-screen
            // We use 'fixed' positioning to ensure it's not affected by the mobile scrolling div
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '-10000px'; 
            container.style.left = '0';
            container.style.zIndex = '-1';
            document.body.appendChild(container);

            // 2. Clone the invoice
            const clone = originalInvoice.cloneNode(true);
            
            // 3. FORCE DESKTOP STYLES ON THE CLONE
            // Remove mobile scaling, set fixed width to A4 size
            clone.style.transform = 'none';
            clone.style.margin = '0';
            clone.style.width = '210mm';
            clone.style.height = 'auto';
            clone.style.minHeight = '297mm';
            
            container.appendChild(clone);

            // 4. Capture the clone
            // We use a timeout to let the DOM render the clone
            setTimeout(() => {
                html2canvas(clone, {
                    scale: 2, // High resolution
                    useCORS: true,
                    windowWidth: 210 * 3.78 + 100, // Ensure window is wide enough for A4 (mm to px approx)
                    backgroundColor: "#ffffff"
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Invoice-${document.getElementById('invoice-no').value}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    
                    // Cleanup
                    document.body.removeChild(container);
                }).catch(err => {
                    alert("Error: " + err);
                    document.body.removeChild(container);
                });
            }, 100);
        }
    </script>
</body>
</html>